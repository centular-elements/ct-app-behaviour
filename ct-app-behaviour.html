<script>
  window.CT = window.CT || {};
  window.CT.Behaviours = window.CT.Behaviours || {};
  CT.Behaviours.App = {
    properties: {
      page: {
        type: String,
        reflectToAttribute: true,
        observer: '_pageChanged'
      }
    },
    listeners: {
      'toast': '_toast',
      'ct-page-to': '_pageTo'
    },
    observers: [
      '_routeChanged(routeData)',
      '_authenticateUser(token)',
      '_routePageChanged(routeData.page, signedIn)',
      '_toggleRefreshBtn(page, signedIn)',
      '_setClientId(clientId)',
      '_refresh(clientId)'
    ],

    _routeChanged: function(routeData) {
      if (routeData.prefix !== '/oauth') {
        return;
      }

      if (routeData.__queryParams.access_token) {
        this._setToken(routeData.__queryParams.access_token);
      }

      // TODO handle errors

      window.history.pushState(null,'','/');
    },

    _setToken: function(token) {
      this.$.storage.value = this.token = CT.token = token;
      this.$.storage.save();
    },

    _authenticateUser: function(token) {
      /*if (!token) {
        this.user = null;
        return;
      }
       this.signedIn = true;

      this.$.usersAPI.getLoggedInUser()
              .then(function(request) {
                this.user = request.response;
                CT.userId = this.user.id;
                this.fire('ct-sign-in', request.response);
              }.bind(this))
              .catch(ExpiredTokenError, function() {
                this._setToken(null);
                this.signIn();
              }.bind(this))
              .catch(function(error) {
                this.fire('ct-sign-in-error', error);
              }.bind(this));*/
    },

    _routePageChanged: function(page, signedIn) {
      if (!signedIn) {
        return this.page = 'signin';
      }
      if (!page && this.defaultPage.menuItem) {
        window.history.pushState(null, '', this.defaultPage.menuItem.href);
      }
      this.page = page || this.defaultPage.name;
    },
    _pageChanged: function(page) {
      if (!page) {
        return;
      }
      // load page import on demand.
      this.importHref(this.resolveUrl('views/' + this.appHandle + '-' + page + '.html'), null, null, true);
    },
    _closeDrawer: function() {
      if (this.$.drawer.persistent) {
        return;
      }
      this.$.drawer.close();
    },
    _computeMenuItems: function(signedIn) {
      return !signedIn ? [] : this.pages.filter(function (page) {
        return page.menuItem;
      });
    },
    _getPageTitle: function(page) {
      return this.pages.reduce(function(prev, curr) {
        if (!prev && curr.name === page) {
          return curr.title;
        }
        return prev;
      }, null);
    },
    _navigateBack: function() {
      window.history.back();
    },
    _toggleRefreshBtn: function(page, signedIn) {
      this.$.refreshBtn.hidden = !signedIn || this.refreshablePages.indexOf(page) === -1;
    },
    _refresh: function() {
      if (this.activeView.refresh) {
        this.activeView.refresh();
      }
    },
    _computeRefreshBtnClass: function(refreshing) {
      return refreshing ? 'rotating' : '';
    },
    _toast: function(event, message) {
      this.$.toast.show(message);
    },
    _computePermission: function(signedIn) {
      return signedIn ? 'bWFuYWdlbWVudF9jb25zb2xlOnZpZXc6b3JnYW5pc2F0aW9u' : null;
    },
    _pageTo: function(event, detail) {
      window.history.pushState(null,'',detail);
      this.fire('location-changed');
    },
    /**
     * App pages.
     * @returns {Page[]}
     */
    get pages() {
      console.warn('No app pages registered');
      return [];
    },
    /**
     * The app handle. Used to determine view prefixes.
     * @returns {String}
     */
    get appHandle() {
      console.warn('App handle not defined');
    },
    /**
     * The default app page.
     * @returns {Page}
     */
    get defaultPage() {
      console.warn('Default page not defined');
      return CT.Page();
    },
    /**
     * The app pages that can be refreshed.
     * @returns {String[]}
     */
    get refreshablePages() {
      return [];
    }
  };
  CT.Page = function(name, title, menuItem) {
    return {
      name: name,
      title: title,
      menuItem: menuItem
    };
  };
  CT.PageMenuItem = function(name, href, icon) {
    return {
      name: name,
      href: href,
      icon: icon
    };
  };
</script>