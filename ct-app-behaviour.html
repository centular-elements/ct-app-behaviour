<script>
  window.CT = window.CT || {};
  window.CT.Behaviours = window.CT.Behaviours || {};
  CT.Behaviours.App = {
    properties: {
      page: {
        type: String,
        reflectToAttribute: true,
        observer: '_pageChanged'
      }
    },
    listeners: {
      'toast': '_toast',
      'ct-page-to': '_pageTo',
      'ct-sign-in': '_signedIn',
      'ct-sign-out': '_signedOut'
    },
    observers: [
      '_routePageChanged(routeData.page, signedIn)',
      '_toggleRefreshBtn(page, signedIn)',
      '_setClientId(clientId)',
      '_refresh(clientId)'
    ],

    _signedIn: function() {
      this.signedIn = true;
    },

    _signedOut: function() {
      this.signedIn = false;
    },

    _getTokenRedirectUri: function() {
      return [window.location.origin, '/oauth'].join('')
    },

    _getSignInPage: function() {
      return [window.location.origin, '/sign-in'].join('')
    },

    _routePageChanged: function(page, signedIn) {
      if (!signedIn) {
        return this.page = 'sign-in';
      }
      if (!page && this.defaultPage.menuItem) {
        window.history.pushState(null, '', this.defaultPage.menuItem.href);
      }
      this.page = page || this.defaultPage.name;
    },
    _pageChanged: function(page) {
      if (!page) {
        return;
      }
      // load page import on demand.
      this.importHref(this.resolveUrl('views/' + this.appHandle + '-' + page + '.html'), null, null, true);
    },
    _closeDrawer: function() {
      if (this.$.drawer.persistent) {
        return;
      }
      this.$.drawer.close();
    },
    _computeMenuItems: function(signedIn) {
      return !signedIn ? [] : this.pages.filter(function (page) {
        return page.menuItem;
      });
    },
    _getPageTitle: function(page) {
      return this.pages.reduce(function(prev, curr) {
        if (!prev && curr.name === page) {
          return curr.title;
        }
        return prev;
      }, null);
    },
    _navigateBack: function() {
      window.history.back();
    },
    _toggleRefreshBtn: function(page, signedIn) {
      this.$.refreshBtn.hidden = !signedIn || this.refreshablePages.indexOf(page) === -1;
    },
    _refresh: function() {
      if (this.activeView.refresh) {
        this.activeView.refresh();
      }
    },
    _computeRefreshBtnClass: function(refreshing) {
      return refreshing ? 'rotating' : '';
    },
    _toast: function(event, message) {
      this.$.toast.show(message);
    },
    _pageTo: function(event, detail) {
      window.history.pushState(null,'',detail);
      this.fire('location-changed');
    },
    /**
     * App pages.
     * @returns {Page[]}
     */
    get pages() {
      console.warn('No app pages registered');
      return [];
    },
    /**
     * The app handle. Used to determine view prefixes.
     * @returns {String}
     */
    get appHandle() {
      console.warn('App handle not defined');
    },
    /**
     * The default app page.
     * @returns {Page}
     */
    get defaultPage() {
      console.warn('Default page not defined');
      return CT.Page();
    },
    /**
     * The app pages that can be refreshed.
     * @returns {String[]}
     */
    get refreshablePages() {
      return [];
    }
  };
  CT.Page = function(name, title, menuItem) {
    return {
      name: name,
      title: title,
      menuItem: menuItem
    };
  };
  CT.PageMenuItem = function(name, href, icon) {
    return {
      name: name,
      href: href,
      icon: icon
    };
  };
</script>